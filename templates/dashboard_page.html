{{ define "dashboard_page.html" }}
{{ template "base.html" . }}
{{ end }}

{{ define "content" }}
<div class="page-header">
    <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
    <p class="page-subtitle">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</p>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">üìà –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 30 –¥–Ω–µ–π</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <!-- –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤ -->
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">üí∞</div>
                <div class="stat-title">–î–æ—Ö–æ–¥—ã –æ—Ç –∏–Ω–∫–∞—Å—Å–∞—Ü–∏–π</div>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart" width="250" height="120"></canvas>
            </div>
            <div class="stat-trend" id="revenueTrend">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- –ì—Ä–∞—Ñ–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–π -->
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">üìã</div>
                <div class="stat-title">–û–ø–µ—Ä–∞—Ü–∏–∏ –≤ –¥–µ–Ω—å</div>
            </div>
            <div class="chart-container">
                <canvas id="operationsChart" width="250" height="120"></canvas>
            </div>
            <div class="stat-trend" id="operationsTrend">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- –ì—Ä–∞—Ñ–∏–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è -->
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">üì¶</div>
                <div class="stat-title">–°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</div>
            </div>
            <div class="chart-container">
                <canvas id="inventoryChart" width="250" height="120"></canvas>
            </div>
            <div class="stat-trend" id="inventoryTrend">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–æ–≤ -->
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">ü§ñ</div>
                <div class="stat-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–æ–≤</div>
            </div>
            <div class="chart-container">
                <canvas id="machinesChart" width="250" height="120"></canvas>
            </div>
            <div class="stat-trend" id="machinesTrend">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- –û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">üìÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h2>
    <div class="chart-container-large">
        <canvas id="weeklyOperationsChart" height="250"></canvas>
    </div>
</div>

<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div class="stat-card-simple">
            <div class="stat-value">{{.TotalMachines}}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–æ–≤</div>
        </div>
        
        <div class="stat-card-simple">
            <div class="stat-value">{{.ActiveMachines}}</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
        
        <div class="stat-card-simple">
            <div class="stat-value">{{.TotalCash}}</div>
            <div class="stat-label">–ù–∞–ª–∏—á–Ω—ã–µ –≤ –∞–≤—Ç–æ–º–∞—Ç–∞—Ö</div>
        </div>
        
        <div class="stat-card-simple">
            <div class="stat-value">{{.TotalToys}}</div>
            <div class="stat-label">–ò–≥—Ä—É—à–µ–∫ –≤ –∞–≤—Ç–æ–º–∞—Ç–∞—Ö</div>
        </div>
        
        <div class="stat-card-simple">
            <div class="stat-value">{{.TotalOperations}}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</div>
        </div>
        
        <div class="stat-card-simple">
            <div class="stat-value">{{.TotalValue}}</div>
            <div class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</div>
        </div>
    </div>
</div>

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class="card">
        <h3>üì¶ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</h3>
        <div style="margin-top: 1rem;">
            {{range .InventoryByType}}
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem; border-radius: 6px;">
                <div>
                    <div style="font-weight: 500;">{{.TypeName}}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">{{.Count}} –µ–¥.</div>
                </div>
                <span style="font-weight: 600; color: var(--primary);">{{printf "%.2f" .Value}} ‚ÇΩ</span>
            </div>
            {{end}}
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="card">
        <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
            <button class="btn btn-primary" 
                    hx-get="/warehouses/inventory-form" 
                    hx-target="#modal-body"
                    onclick="VendERP.showModal()">
                üì¶ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
            </button>
            <button class="btn btn-secondary" 
                    hx-get="/warehouses/form" 
                    hx-target="#modal-body"
                    onclick="VendERP.showModal()">
                üè≠ –î–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥
            </button>
            <button class="btn btn-warning" 
                    hx-get="/operations/form" 
                    hx-target="#modal-body"
                    onclick="VendERP.showModal()">
                üìã –ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
            </button>
        </div>
    </div>
</div>

<!-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ -->
{{if .LowStockItems}}
<div class="card" style="margin-top: 1.5rem;">
    <h3>üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏</h3>
    <div style="margin-top: 1rem;">
        {{range .LowStockItems}}
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem; padding: 0.75rem; background: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--warning); border-radius: 4px;">
            <div>
                <div style="font-weight: 500;">{{.ItemName}}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">{{.WarehouseName}}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 600; color: var(--warning);">{{.Quantity}}/{{.MinStockLevel}}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">–æ—Å—Ç–∞–ª–æ—Å—å ({{printf "%.0f" (mult .Quantity 100.0) | percent .MinStockLevel}}%)</div>
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}

<style>
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid var(--border);
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.stat-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.stat-icon {
    font-size: 1.5rem;
    margin-right: 0.5rem;
}

.stat-title {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.chart-container {
    height: 120px;
    margin: 0.5rem 0;
}

.chart-container-large {
    height: 250px;
    margin: 0.5rem 0;
}

.stat-trend {
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 0.5rem;
}

.stat-trend.positive {
    color: var(--success);
}

.stat-trend.negative {
    color: var(--danger);
}

.stat-card-simple {
    text-align: center;
    padding: 1rem;
    background: var(--surface);
    border-radius: 8px;
    border: 1px solid var(--border);
}

.stat-card-simple .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.25rem;
}

.stat-card-simple .stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.page-subtitle {
    color: var(--text-secondary);
    margin-top: 0.5rem;
    font-size: 1.1rem;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ç—Ä–µ–Ω–¥–∞
    function calculateTrend(data) {
        if (data.length < 2) return 0;
        const first = data[0] || 0;
        const last = data[data.length - 1] || 0;
        if (first === 0) return 0;
        return ((last - first) / first) * 100;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞
    function formatTrend(trend) {
        const absTrend = Math.abs(trend).toFixed(1);
        if (trend > 0) {
            return `<span class="stat-trend positive">+${absTrend}%</span>`;
        } else if (trend < 0) {
            return `<span class="stat-trend negative">-${absTrend}%</span>`;
        } else {
            return `<span class="stat-trend">0%</span>`;
        }
    }

    // –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: {{.RevenueChart.Labels}},
            datasets: {{.RevenueChart.Datasets}}
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `–î–æ—Ö–æ–¥: ${context.parsed.y.toFixed(2)} ‚ÇΩ`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { display: false },
                    ticks: {
                        callback: function(value) {
                            return value + ' ‚ÇΩ';
                        }
                    }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–Ω–¥ –¥–æ—Ö–æ–¥–æ–≤
    const revenueTrend = calculateTrend({{.RevenueChart.Datasets}}[0].data);
    document.getElementById('revenueTrend').innerHTML = formatTrend(revenueTrend);

    // –ì—Ä–∞—Ñ–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
    const operationsCtx = document.getElementById('operationsChart').getContext('2d');
    const operationsChart = new Chart(operationsCtx, {
        type: 'line',
        data: {
            labels: {{.OperationsTrend.Labels}},
            datasets: {{.OperationsTrend.Datasets}}
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `–û–ø–µ—Ä–∞—Ü–∏–π: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { display: false },
                    ticks: {
                        precision: 0
                    }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–Ω–¥ –æ–ø–µ—Ä–∞—Ü–∏–π
    const operationsTrend = calculateTrend({{.OperationsTrend.Datasets}}[0].data);
    document.getElementById('operationsTrend').innerHTML = formatTrend(operationsTrend);

    // –ì—Ä–∞—Ñ–∏–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
    const inventoryChart = new Chart(inventoryCtx, {
        type: 'line',
        data: {
            labels: {{.InventoryChart.Labels}},
            datasets: {{.InventoryChart.Datasets}}
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${context.parsed.y.toFixed(2)} ‚ÇΩ`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: false, 
                    grid: { display: false },
                    ticks: {
                        callback: function(value) {
                            return value + ' ‚ÇΩ';
                        }
                    }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–Ω–¥ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    const inventoryTrend = calculateTrend({{.InventoryChart.Datasets}}[0].data);
    document.getElementById('inventoryTrend').innerHTML = formatTrend(inventoryTrend);

    // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–æ–≤
    const machinesCtx = document.getElementById('machinesChart').getContext('2d');
    const machinesChart = new Chart(machinesCtx, {
        type: 'line',
        data: {
            labels: {{.MachinesActivity.Labels}},
            datasets: {{.MachinesActivity.Datasets}}
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${context.parsed.y.toFixed(1)}%`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 100,
                    grid: { display: false },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–Ω–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    const machinesTrend = calculateTrend({{.MachinesActivity.Datasets}}[0].data);
    document.getElementById('machinesTrend').innerHTML = formatTrend(machinesTrend);

    // –ì—Ä–∞—Ñ–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
    const weeklyCtx = document.getElementById('weeklyOperationsChart').getContext('2d');
    new Chart(weeklyCtx, {
        type: 'bar',
        data: {
            labels: {{.WeeklyOperations.Labels}},
            datasets: {{.WeeklyOperations.Datasets}}
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    grid: { display: false },
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
});
</script>
{{ end }}